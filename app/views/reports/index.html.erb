<div class="row col-sm-12">
  <%= form_tag room_reports_path(@room), method: :get, class: 'form-horizontal', role: "form" do %>
    <div class="form-group col-sm-3">
      <div id="datetimepicker1" class="input-append date">
         <%= text_field_tag :start_time, params[:start_time], 'data-format': "dd/MM/yyyy hh:mm:ss", placeholder: "开始时间", required: true%>
          <span class="add-on">
            <i data-time-icon="glyphicon glyphicon-time" data-date-icon="glyphicon glyphicon-calendar">
            </i>
          </span>
      </div>
    </div>
    <div class="form-group col-sm-3">
      <div id="datetimepicker2" class="input-append date">
        <%= text_field_tag :end_time, params[:end_time], 'data-format': "dd/MM/yyyy hh:mm:ss", placeholder: "截止时间", required: true %>
          <span class="add-on">
            <i data-time-icon="glyphicon glyphicon-time" data-date-icon="glyphicon glyphicon-calendar">
            </i>
          </span>
      </div>
    </div>
    <%= submit_tag "搜索", class: "btn btn-xs btn-default" %>
  <% end %>
</div>
<hr>
<div class="row" id="reportsContent">
  <div class="col-sm-12">
    <div class="col-sm-3">
      <ul id="deviceContent" style="max-height: 540px;overflow: auto;">
        <% @devices.each do |device| %>
          <li class="parent"><%= link_to "+ " + device.name.to_s, "javascript:void(0);" %></li>
          <ul id="pointContent">
            <% device.points.each do |point| %>
              <!-- 搜索报表数据 -->
              <% phs = PointHistory.order("created_at asc").keyword(params[:start_time], params[:end_time], point.id)%>
              <% if phs.length <= 20 %>
                <% pds = PointHistory.where({id: phs.collect{|x| x.id.to_i}}).collect{|x| x.point_value.to_i} %>
                <% pts = PointHistory.where({id: phs.collect{|x| x.id.to_i}}).collect{|x| x.created_at.strftime("%Y-%m-%d")} %>
              <% elsif 10 < phs.length <= 100 %>
                <% pds = PointHistory.where({id: phs.collect{|x| x.id.to_i%4 == 0}}).collect{|x| x.point_value.to_i} %>
                <% pts = PointHistory.where({id: phs.collect{|x| x.id.to_i%4 == 0}}).collect{|x| x.created_at.strftime("%Y-%m-%d")} %>
              <% elsif 100 < phs.length <= 1000 %>
                <% pds = PointHistory.where({id: phs.collect{|x| x.id.to_i%50 == 0}}).collect{|x| x.point_value.to_i} %>
                <% pts = PointHistory.where({id: phs.collect{|x| x.id.to_i%50 == 0}}).collect{|x| x.created_at.strftime("%Y-%m-%d")} %>
              <% elsif 1000 < phs.length <= 10000 %>
                <% pds = PointHistory.where({id: phs.collect{|x| x.id.to_i%500 == 0}}).collect{|x| x.point_value.to_i} %>
                <% pts = PointHistory.where({id: phs.collect{|x| x.id.to_i%500 == 0}}).collect{|x| x.created_at.strftime("%Y-%m-%d")} %>
              <% elsif 10000 < phs.length <= 100000 %>
                <% pds = PointHistory.where({id: phs.collect{|x| x.id.to_i%5000 == 0}}).collect{|x| x.point_value.to_i} %>
                <% pds = PointHistory.where({id: phs.collect{|x| x.id.to_i%5000 == 0}}).collect{|x| x.created_at.strftime("%Y-%m-%d")} %>
              <% end %>
              
              <!-- 默认报表数据 -->
              <% dhs = PointHistory.order("created_at asc").limit(20) %>
              <% dds = PointHistory.where({id: dhs.collect{|x| x.id.to_i}}).collect{|x| x.point_value.to_i} %>
              <% dts = PointHistory.where({id: dhs.collect{|x| x.id.to_i}}).collect{|x| x.created_at.strftime("%Y-%m-%d %H:%M:%S")} %>

              <li class="child"><%= link_to point.name, replace_chart_room_reports_path(@room, data: pds, time: pts, name: point.name), remote: true, title: point.name, 'data-default-history': dds.to_json, 'data-default-time': dts.to_json %></li>
            <% end %>
          </ul>
        <% end %>
      </ul>
    </div>
    <div class="col-sm-9" id="chartsContent">
      <div id="main" style="height:400px"></div>
    </div>
  </div>
</div>

<script type="text/javascript">
  var defaultTime = $(".child a").data("default-time");
  var defaultHistory = $(".child a").data("default-history");
  require(
      [
          'echarts',
          'echarts/chart/line' // 使用柱状图就加载bar模块，按需加载
      ],
      function (ec) {
        // 基于准备好的dom，初始化echarts图表
        var myChart = ec.init(document.getElementById('main')); 
        option = {
        tooltip : {
            trigger: 'axis'
        },
        legend: {
            data:['报表']
        },
        calculable : true,
        xAxis : [
            {
                type : 'category',
                boundaryGap : false,
                data : defaultTime
            }
        ],
        yAxis : [
            {
                type : 'value'
            }
        ],
        series : [
            {
                name:'值',
                type:'line',
                data: defaultHistory
            }
        ]
    };
      // 为echarts对象加载数据
      myChart.setOption(option);
    }
  );
</script>

<script type="text/javascript">
  $(function(){
    $("#deviceContent li").click(function(){
      $(this).next("ul").slideToggle();
      $(this).siblings("li").next("ul").hide();
    });
  })
</script>
<!--
<script type="text/javascript">
    // 使用
    require(
      [
          'echarts',
          'echarts/chart/bar' // 使用柱状图就加载bar模块，按需加载
      ],
      function (ec) {
        // 基于准备好的dom，初始化echarts图表
        var myChart = ec.init(document.getElementById('main')); 
        var option = {
          tooltip: {
              show: true
          },
          legend: {
              data:['报表']
          },
          xAxis : [
              {
                  type : 'category',
                  data : ["2016-01-01"]
              }
          ],
          yAxis : [
              {
                  type : 'value'
              }
          ],
          series : [
            {
              "name":"报表",
              "type":"bar",
              "data": [0]
            }
          ]
        };
      // 为echarts对象加载数据
      myChart.setOption(option);
    }
  );
</script>
-->
<script type="text/javascript">
  $(function() {
    $('#datetimepicker1, #datetimepicker2').datetimepicker({
       collapse: false
    });
  });
</script>