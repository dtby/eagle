<div class="power__ups">
  <div class="col-md-12 clearfix">
    <div class="panel panel-default">
      <div class="panel-body text-center">
        <h2><%= device.name %></h2>
      </div>
    </div>
  </div>
  
  <div class="col-md-12 clearfix">
    <div class="col-md-8 mblock ups-up ups-up-left">
    <div class="row">
      <div class="col-xs-4 p-r"></div>
      <div class="col-xs-8 p-l">
        <%=image_tag"power-ups2.jpg",width:"65%", height: "90%", id: 'ups_img'%>
        <!-- 左侧表格1 -->
        <div class="table-responsive table-left1">
          <% if @points['市电输入'].present? %>
            <%= render partial: "devices/share/table", locals: { title: "市电输入", points: @points["市电输入"] } %>
          <% elsif @points['市电输出'].present? %>
            <%= render partial: "devices/share/table", locals: { title: "市电输出", points: @points["市电输出"] } %>
          <% end %>
        </div>
        <!-- 右侧表格 -->
        <% if @points["UPS输出"].present? %>
          <div class="table-responsive table-right">
            <%= render partial: "devices/share/table", locals: { title: "UPS输出", points: @points["UPS输出"] } %>
          </div>
        <% end %>
        <!-- 下部表格 -->
        <div class="table-responsive table-bottom">
          <% if @points['电池模块'].present? %>
            <%= render partial: "devices/share/table", locals: { title: "电池模块", points: @points["电池模块"] } %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
  
  <% if @points["告警"].present? %>
    <div class="col-md-4 ups-up ups-up-right">
      <div class="panel panel-default warn-info">
        <div class="panel-heading text-center"><h4>报警信息</h4></div>
        <div class="panel-body" >
          <div class="content">
            <% @points["告警"].each do |key, value| %>
              <div class="col-xs-12" style="margin-bottom: 10px;">
                <span class="warning-name"><%= key %></span>
                <span class="warning-icon"><%= warning_status value[:state] %></span>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  <% elsif @points['开关'].present? %>
    <div class="col-md-4">
      <div class="panel panel-default">
        <div class="panel-heading">开关状态</div>
        <div id="switch-container" class="panel-body switch-container">
          <% @points["开关"].each do |key, value| %>
            <div class='col-xs-12 switch-area'>
              
                <div class="title"><%= key %></div>
                <div class="myswitcher">
                  <label data-name="<%= key %>" class="myswitcher-label <%= value == '0' ? 'myswitcher-apart' : 'myswitcher-comb' %>">
                    <span class="myswitcher-inner"><%= value == '0' ? '分' : '合' %></span>
                    <span class="myswitcher-switch"></span>
                  </label>
                </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>  
  </div>
  
  <% if @load_factor.present? %>
  <div class="col-md-12 clearfix">
    <div class="mblock part-bar">
      <span class="text-muted">输出负载率</span>
      <div id="ups_bar" style="width: 100%;"></div>
    </div>
  </div>
  <% end %>

  <% if  @points["表格"].present? %>
  <div class="col-md-12">
    <div class="mblock part-pie">
      <div id="ups_bar2" style="width: 100%;"></div>
    </div>
  </div>
  <% end %>
</div>

<script type="text/javascript">
  clearInterval(refresh_page);
  var refresh_page = setInterval(function(){
    get_data();
  }, 20000)

  function get_data() {
    $.ajax({
      type: 'get',
      async: true,
      url: "/rooms/<%= @room.id %>/devices/<%= @device.id %>?api_version=9",
      headers: {Accept: 'application/json'},
      success: function(json) {
        var _list = ['电池模块', 'UPS输出', '市电输入']
        for (var i = 0; i < _list.length; i++) {
          var _item = _list[i];
          $("#table_" + _item).find('td').each(function(index, el) {
            var _target = $(el);
            var _name = _target.attr('data-name');
            if (_name != undefined) {
              _target.text(json.result[_item][_name].state);
              _target.removeClass().addClass(json.result[_item][_name].color);
            }
          });
        }
        var _switch_content_size = $("#switch-container").children().size();
        $("#switch-container").children().each(function(index, el) {
          var _label_target = $(el).find('label');
          var _label_name = _label_target.attr('data-name');
          
          var target_result = json.result['开关'][_label_name].state;
          if (target_result == 0) {
            _label_target.removeClass('myswitcher-apart').addClass('myswitcher-comb');
            _label_target.find('.myswitcher-inner').html('合');
          } else {
            _label_target.removeClass('myswitcher-comb').addClass('myswitcher-apart');
            _label_target.find('.myswitcher-inner').html('分');
          }
        });
      },
      fail: function(error) {
      }
    });
  }

  // 路径配置
  require.config({
    paths: {
      echarts: '/assets/echarts'
    }
  });
  <% if @load_factor.present? %>
  // 条形图
  require(
    [
    'echarts',
      'echarts/chart/bar', // 使用柱状图就加载bar模块，按需加载
      ],
      function (bar) {
      // 基于准备好的dom，初始化echarts图表
      var upsBar = bar.init(document.getElementById('ups_bar'), 'macarons');

      var option = {
        grid : {
          y : 5,
          x2 : 5,
          y2 : 5,
          x : 5
        },
        tooltip : {
          trigger: 'axis'
        },
        xAxis : [
        {
          type : 'category',
          data : ['','','','','','','','','','','','','','','','','','','','','','','','']
        }
        ],
        yAxis : [
        {
          type : 'value'
        }
        ],
        series : [
        {
          name:'负载率',
          type:'bar',
          itemStyle:{
            normal:{
              color:'#00cae1'
            }
          },
          data:[7.0, 16.9, 40.0, 12.2, 32.6, 20.0, 30.4, 18.6, 22.2, 3.3,2.0, 4.9, 7.0, 23.2, 23.2, 25.6, 76.7, 135.6, 25.6, 76.7, 32.6, 20.0, 6.4, 3.3],
        }
        ],
      };
      // 为echarts对象加载数据
      upsBar.setOption(option);
    }
    );
  <% end %>
  <% if @device_consume.present? %>
  // 条形图
  require(
    [
    'echarts',
    'echarts/chart/line', // 使用柱状图就加载bar模块，按需加载
    ],
    function (line) {
      // 基于准备好的dom，初始化echarts图表
      var upsBar2 = line.init(document.getElementById('ups_bar2'), 'macarons');

      var option = {
        grid: { y: 55, x2: 15, y2: 25, x: 35 },
        tooltip: { trigger: 'axis' },
        legend: {
          x: 'right',
          data:[
            <% @device_consume.keys.each do |key| %>
              "<%= key %>",
            <% end %>
          ]
        },
        xAxis : [
        {
          type : 'category',
          data : [
            <% @device_consume.first.second.each do |item| %>
              "<%= item.created_at.strftime('%F %H:%M') %>",
            <% end %>
          ]
        }
        ],
        yAxis : [{ type : 'value' }],
        series : [
        <% @device_consume.each do |key, items| %>
          {
            name:'<%= key %>',
            type:'line',
            data:[
              <% items.each do |item|%>
                <%= item.point_value %>,
              <% end %>
            ],
          },
        <% end %>
        ]
      };
      // 为echarts对象加载数据
      upsBar2.setOption(option);
    }
  );
  <% end %>
</script>
